syntax = "proto3";
package ar.v1;

import "ar/v1/permissions.proto";
import "buf/validate/validate.proto";
import "common/v1/color.proto";
import "geometry/v1/anchor.proto";
import "geometry/v1/pose.proto";
import "geometry/v1/vector3.proto";
import "validation/v1/predefined_string_rules.proto";

option csharp_namespace = "Messages.AR.V1";
option go_package = "github.com/cobotar/protocol/messages/ar/v1";

// Used to specify the type of a property
enum PropertyType {
  PROPERTY_TYPE_UNSPECIFIED = 0;
  PROPERTY_TYPE_BOOL = 1;
  PROPERTY_TYPE_INT = 2;
  PROPERTY_TYPE_FLOAT = 3;
  PROPERTY_TYPE_DOUBLE = 4;
  PROPERTY_TYPE_STRING = 5;
  PROPERTY_TYPE_VECTOR3 = 6;
  PROPERTY_TYPE_POSE = 7;
  PROPERTY_TYPE_ANCHOR = 8;
  PROPERTY_TYPE_COLOR = 9;
  PROPERTY_TYPE_ROBOT = 10;
  PROPERTY_TYPE_ENUM = 11;
  PROPERTY_TYPE_ENUM_MULTI = 12;
  PROPERTY_TYPE_ICON = 13;
  PROPERTY_TYPE_ASSET = 14;
}

// Specifies where the value of a property originates from.
enum PropertyOrigin {
  PROPERTY_ORIGIN_UNSPECIFIED = 0;
  PROPERTY_ORIGIN_FIXED = 1; // The value of the property is fixed and must be changed manually
  PROPERTY_ORIGIN_MIRROR = 2; // The value of the property mirrors the value of another property
}

enum PropertyGroup {
  PROPERTY_GROUP_UNSPECIFIED = 0;
  PROPERTY_GROUP_OUTPUT = 1;
  PROPERTY_GROUP_NON_EDITABLE = 2;
  PROPERTY_GROUP_STYLING = 3;
  PROPERTY_GROUP_LOCATION = 4;
  PROPERTY_GROUP_ICON = 5;
  PROPERTY_GROUP_CONFIGURATION = 6;
  PROPERTY_GROUP_HIDDEN = 7;
}

// Properties are used by various components to define them, such as: feedback, actions, and conditions.
message Property {
  option (buf.validate.message).cel = {
    id: "property_type_matches_value_kind"
    message: "type must match the kind of value field"
    expression: "((this.type == 1 && has(this.bool_value)) || (this.type == 2 && has(this.int_value)) || (this.type == 3 && has(this.float_value)) || (this.type == 4 && has(this.double_value)) || (this.type == 5 && has(this.string_value)) ||(this.type == 6 && has(this.vector3_value)) || (this.type == 7 && has(this.pose_value)) || (this.type == 8 && has(this.anchor_value)) || (this.type == 9 && has(this.color_value)) || (this.type == 10 && has(this.robot_id_value)) || (this.type == 11 && has(this.enum_value)) ||(this.type == 12 && size(this.enum_multi_value) > 0) || (this.type == 13 && has(this.icon_value)) || (this.type == 14 && has(this.asset_id_value)))"
  };

  option (buf.validate.message).oneof = {
    fields: [
      "bool_value",
      "int_value",
      "float_value",
      "double_value",
      "string_value",
      "vector3_value",
      "pose_value",
      "anchor_value",
      "color_value",
      "robot_id_value",
      "enum_value",
      "enum_multi_value",
      "icon_value",
      "asset_id_value"
    ]
    required: true
  };

  option (buf.validate.message).oneof = {
    fields: [
      "number_extras",
      "enum_extras",
      "vector3_extras",
      "color_extras",
      "pose_extras",
      "anchor_extras"
    ]
  };

  option (buf.validate.message).cel = {
    id: "mirror_requires_mirror_property_id"
    message: "mirror_property_id must be set when origin is MIRROR"
    expression: "this.origin != 2 || this.mirror_property_id != ''"
  };

  option (buf.validate.message).cel = {
    id: "output_must_be_fixed"
    message: "output properties must have origin FIXED"
    expression: "this.group != 1 || this.origin == 1"
  };

  option (buf.validate.message).cel = {
    id: "enum_requires_enum_extras"
    message: "enum_extras must be set when type is ENUM or ENUM_MULTI"
    expression: "!(this.type == 11 || this.type == 12) || has(this.enum_extras)"
  };

  option (buf.validate.message).cel = {
    id: "enum_value_must_be_in_options"
    message: "enum_value must be one of enum_extras.options[].value"
    expression: "this.type != 11 || this.enum_extras.options.exists(o, o.value == this.enum_value)"
  };

  option (buf.validate.message).cel = {
    id: "enum_multi_values_must_be_in_options"
    message: "enum_multi_value values must be in enum_extras.options[].value"
    expression: "this.type != 12 || this.enum_multi_value.all(v, this.enum_extras.options.exists(o, o.value == v))"
  };

  string id = 1;
  string name = 2 [(buf.validate.field).string.(validation.v1.name_component) = true];
  string icon = 3;
  string description = 4;
  PropertyType type = 5 [
    (buf.validate.field).required = true,
    (buf.validate.field).enum.defined_only = true
  ];
  WorkerPermission minimum_required_permission = 6 [(buf.validate.field).enum.defined_only = true];
  PropertyOrigin origin = 7 [(buf.validate.field).enum.defined_only = true];
  repeated PropertyOrigin origins = 8 [(buf.validate.field).repeated.items.enum.defined_only = true];
  string mirror_property_id = 9;
  PropertyGroup group = 10;
  int32 ordering = 11;
  bool hide_group = 12;
  string parent_id = 13;
  bool advanced = 14; // Hide behind "Advanced" toogle
  string scope_id = 15;

  optional bool bool_value = 21;
  optional sint64 int_value = 22;
  optional float float_value = 23;
  optional double double_value = 24;
  optional string string_value = 25;
  geometry.v1.Vector3 vector3_value = 26;
  geometry.v1.LocalizedPose pose_value = 27;
  geometry.v1.Anchor anchor_value = 28;
  common.v1.Color color_value = 29;
  optional string robot_id_value = 30;
  optional string enum_value = 31 [(buf.validate.field).string.min_len = 1];
  repeated string enum_multi_value = 32 [(buf.validate.field).repeated = {
    min_items: 1
    items: {
      string: {min_len: 1}
    }
  }];
  optional string icon_value = 33;
  optional string asset_id_value = 34;

  NumberExtras number_extras = 41;
  EnumExtras enum_extras = 42;
  Vector3Extras vector3_extras = 43;
  ColorExtras color_extras = 44;
  PoseExtras pose_extras = 45;
  AnchorExtras anchor_extras = 46;
}

message PropertyMessages {
  repeated Property properties = 1;
}

message PropertyValueUpdate {
  option (buf.validate.message).cel = {
    id: "property_type_matches_value_kind"
    message: "type must match the kind of value field"
    expression: "((this.type == 1 && has(this.bool_value)) || (this.type == 2 && has(this.int_value)) || (this.type == 3 && has(this.float_value)) || (this.type == 4 && has(this.double_value)) || (this.type == 5 && has(this.string_value)) ||(this.type == 6 && has(this.vector3_value)) || (this.type == 7 && has(this.pose_value)) || (this.type == 8 && has(this.anchor_value)) || (this.type == 9 && has(this.color_value)) || (this.type == 10 && has(this.robot_id_value)) || (this.type == 11 && has(this.enum_value)) ||(this.type == 12 && size(this.enum_multi_value) > 0) || (this.type == 13 && has(this.icon_value)) || (this.type == 14 && has(this.asset_id_value)))"
  };

  option (buf.validate.message).oneof = {
    fields: [
      "bool_value",
      "int_value",
      "float_value",
      "double_value",
      "string_value",
      "vector3_value",
      "pose_value",
      "anchor_value",
      "color_value",
      "robot_id_value",
      "enum_value",
      "enum_multi_value",
      "icon_value",
      "asset_id_value"
    ]
    required: true
  };

  option (buf.validate.message).cel = {
    id: "mirror_requires_mirror_property_id"
    message: "mirror_property_id must be set when origin is MIRROR"
    expression: "this.origin != 2 || this.mirror_property_id != ''"
  };

  string id = 1;
  PropertyType type = 5 [
    (buf.validate.field).required = true,
    (buf.validate.field).enum.defined_only = true
  ];
  PropertyOrigin origin = 7 [(buf.validate.field).enum.defined_only = true];
  string mirror_property_id = 9;

  optional bool bool_value = 21;
  optional sint64 int_value = 22;
  optional float float_value = 23;
  optional double double_value = 24;
  optional string string_value = 25;
  geometry.v1.Vector3 vector3_value = 26;
  geometry.v1.LocalizedPose pose_value = 27;
  geometry.v1.Anchor anchor_value = 28;
  common.v1.Color color_value = 29;
  optional string robot_id_value = 30;
  optional string enum_value = 31 [(buf.validate.field).string.min_len = 1];
  repeated string enum_multi_value = 32 [(buf.validate.field).repeated = {
    min_items: 1
    items: {
      string: {min_len: 1}
    }
  }];
  optional string icon_value = 33;
  optional string asset_id_value = 34;
}

message NumberExtras {
  option (buf.validate.message).cel = {
    id: "number_extras_consistent"
    message: "If any of min/max/step is set, all must be set; and min < max; and step <= (max-min)"
    expression: "(!has(this.min) && !has(this.max) && !has(this.step)) || (has(this.min) && has(this.max) && has(this.step) && this.min < this.max && this.step <= (this.max - this.min))"
  };

  optional double min = 1;
  optional double max = 2;
  optional double step = 3 [(buf.validate.field).double.gt = 0];
  string unit = 4 [(buf.validate.field).string.max_len = 3]; // "mm", "deg", "N"
  uint32 precision = 5 [(buf.validate.field).uint32.gte = 0]; // Decimal places for display
}

message EnumOption {
  string value = 1 [(buf.validate.field).string.min_len = 1];
  string label = 2 [(buf.validate.field).string.min_len = 1];
  string icon = 3;
  string group = 4;
  bool disabled = 5;
}

message EnumExtras {
  string placeholder = 1; // Placeholder value shown in UI when no enum is selected
  bool filter = 2; // Show filter input
  bool grouped = 3; // If options should be grouped
  bool show_icons = 4; // If options have icons and these should be shown
  uint32 max_selected_labels = 5; // Only relevant for MultiSelect: limits number of selected labels

  repeated EnumOption options = 6 [(buf.validate.field).repeated.min_items = 1];
}

message Vector3Extras {
  option (buf.validate.message).cel = {
    id: "number_extras_consistent"
    message: "If any of min/max/step is set, all must be set; and min < max; and step <= (max-min)"
    expression: "(!has(this.min) && !has(this.max) && !has(this.step)) || (has(this.min) && has(this.max) && has(this.step) && this.min < this.max && this.step <= (this.max - this.min))"
  };

  optional double min = 1;
  optional double max = 2;
  optional double step = 3 [(buf.validate.field).double.gt = 0];
  string label_x = 4 [(buf.validate.field).string.max_len = 5];
  string label_y = 5 [(buf.validate.field).string.max_len = 5];
  string label_z = 6 [(buf.validate.field).string.max_len = 5];
  string unit = 7 [(buf.validate.field).string.max_len = 3];
}

message ColorExtras {
  double step = 1 [(buf.validate.field).double.gte = 0];
  common.v1.Color default = 2;
}

message AnchorExtras {
  bool only_markers = 1;
}

message PoseExtras {
  bool anchor_editable = 1;
  bool pose_editable = 2;
}
